Programming tunnels through PCEP is one of the key features of BGP-LS/PCEP implemented in Opendaylight.
User can create, update and delete tunnel via RESTCONF calls. Tunnel (LSP - Label Switched Path) arguments
are passed through RESTCONF and generate a PCEP message that is sent to PCC (which is also specified via RESTCONF call).
PCC sends a response back to ODL. The response is then interpreted and sent to RESTCONF, where, in case of success,
the new LSP is displayed.

Following is an example how a stateful initiated PCEP session RESTCONF output looks like:

''http://localhost:8080/restconf/operational/network-topology:network-topology/topology/pcep-topology''

 <node>
  <path-computation-client>
  <state-sync>synchronized</state-sync>
  <stateful-tlv>
   <stateful>
    <initiation>true</initiation>
    <lsp-update-capability>true</lsp-update-capability>
   </stateful>
  </stateful-tlv>
  <ip-address>43.43.43.43</ip-address>
  </path-computation-client>
  <node-id>pcc://43.43.43.43</node-id>
 </node>

<big>If your output does '''NOT''' match the above sample (especially the two flags) '''DO NOT''' proceed with tunnel management, as your configuration needs to be adjusted.
Consult [[BGP LS PCEP:User Guide|User Guide]] or [[BGP LS PCEP:Troubleshooting|Troubleshooting]] sites.</big>

== Tunnel Management for draft-ietf-pce-stateful-pce-02 and draft-crabbe-initiated-00 ==

=== Creating LSP ===

An LSP in PCEP is created in two phases. First, you create a simple end-to-end LSP, that is not operational. Making an add-lsp operation will trigger a Pcinitiate message to PCC.
Link to RESTCONF parameters [https://jenkins.opendaylight.org/bgpcep/job/bgpcep-nightly/lastSuccessfulBuild/artifact/target/staging/pcep-parent/pcep-topology-api/network-topology-pcep.html#add-lsp/input/arguments here]

Each RESTCONF operations call requires some xml input that is send via HTTP POST method. Whenever you are sending an xml input, set up HTTP header Content-Type: application/xml.
 
'''RESTCONF URL''' : ''http://localhost:8080/restconf/operations/network-topology-pcep:add-lsp''

'''Method:''' POST

'''Sample input:''' for '''Content-Type:''' application/json

 {
  "input": {
   "node": "pcc://39.39.39.39",
   "name": "update-tunel",
   "network-topology-ref": "/network-topology:network-topology/network-topology:topology[network-topology:topology-id=\"pcep-topology\"]",
   "arguments: {
    "endpoints-obj": {
     "ipv4": {
      "source-ipv4-address": "39.39.39.39",
      "destination-ipv4-address": "43.43.43.43"
     }
    }
   }
  }
 }

'''Sample input:''' for '''Content-Type:''' application/xml

 <input>
  <node>pcc://39.39.39.39</node>
  <name>update-tunel</name>
 <arguments>
  <endpoints-obj>
   <ipv4>
    <source-ipv4-address>39.39.39.39</source-ipv4-address>
    <destination-ipv4-address>43.43.43.43</destination-ipv4-address>
   </ipv4>
  </endpoints-obj>
 </arguments>
 <network-topology-ref xmlns:topo="urn:TBD:params:xml:ns:yang:network-topology">/topo:network-topology/topo:topology[topo:topology-id="pcep-topology"]</network-topology-ref>
 </input>

'''Details:'''
* <node> : specifies node-id of the PCC, where you want to send the PCEP message. PCEP states that the PCC recieving this message needs to be set as the source of the LSP, otherwise it will ignore the <source-ipv4-address> tag and create a tunnel with the PCC set as source. This node-id can be found when listing all the PCC connected to ODL: ''http:/localhost:8080/restconf/operational/network-topology:network-topology/topology/pcep-topology''
* <name> : name of the LSP
* <arguments> : LSP arguments
* <endpoints-obj> : [http://tools.ietf.org/html/rfc5440#section-7.6 Endpoints object], mandatory, stating the source and destination of the LSP

=== Updating LSP ===

Updating is necessary to make LSP operational. It can be also used for adding specific hops to the LSP. Making an update-lsp operation will trigger a Pcupd message to PCC.

'''RESTCONF URL''' : ''http://localhost:8080/restconf/operations/network-topology-pcep:update-lsp''

'''Method:''' POST

'''Content-Type:''' application/xml

'''Sample input:'''

 <input>
  <node>pcc://39.39.39.39</node>
  <name>update-tunel</name>
  <network-topology-ref xmlns:topo="urn:TBD:params:xml:ns:yang:network-topology">/topo:network-topology/topo:topology[topo:topology-id="pcep-topology"]</network-topology-ref>
  <arguments>
    <operational xmlns:stateful02="urn:opendaylight:params:xml:ns:yang:pcep:crabbe:stateful:02">true</operational>
    <ero>
      <subobject>
       <loose>false</loose>
       <ip-prefix><ip-prefix>195.20.160.40/32</ip-prefix></ip-prefix>
      </subobject>
      <subobject>
       <loose>false</loose>
       <ip-prefix><ip-prefix>201.20.160.43/32</ip-prefix></ip-prefix>
      </subobject>
      <subobject>
       <loose>false</loose>
       <ip-prefix><ip-prefix>43.43.43.43/32</ip-prefix></ip-prefix>
      </subobject>
    </ero>
  </arguments>
 </input>

'''Details:'''
* <node> : specifies node-id of the PCC, where you want to send the PCEP message. This node-id can be found when listing all the PCC connected to ODL: ''http:/localhost:8080/restconf/operational/network-topology:network-topology/topology/pcep-topology''
* <name> : name of the LSP that you want to update
* <arguments> : LSP arguments
* <operational> : Mandatory argument specifying [http://tools.ietf.org/html/draft-ietf-pce-stateful-pce-02#section-7.2 O flag]
* <ero> : [http://tools.ietf.org/html/rfc5440#section-7.9 Explicit Route Object], specifies hops between source and destination nodes (in this order). This object can be also passed in arguments when creating LSP. Note: '''ODL does NOT order hops, nor does it validate them, therefore user is responsible for putting correct hops in correct order.'''

=== Removing LSP ===

Removing LSP from PCC is done via following RESTCONF URL. Making a remove-lsp operation will trigger a Pcupd message to PCC, with remove-flag set to true.

'''RESTCONF URL''' : ''http://localhost:8080/restconf/operations/network-topology-pcep:remove-lsp''

'''Method:''' POST

'''Content-Type:''' application/xml

'''Sample input:'''

 <input>
  <node>pcc://39.39.39.39</node>
  <name>update-tunel</name>
  <network-topology-ref xmlns:topo="urn:TBD:params:xml:ns:yang:network-topology">/topo:network-topology/topo:topology[topo:topology-id="pcep-topology"]</network-topology-ref>
 </input>

'''Details:'''
* <node> : specifies node-id of the PCC, where you want to send the PCEP message. This node-id can be found when listing all the PCC connected to ODL: ''http:/localhost:8080/restconf/operational/network-topology:network-topology/topology/pcep-topology''
* <name> : name of the LSP that you want to remove

== Tunnel Management for draft-ietf-pce-stateful-pce-07 and draft-ietf-pce-pce-initiated-lsp-00 ==

=== Creating LSP ===

An LSP in PCEP can be created in one or two steps. If you specify operational-status in the first step, you won't have to make the second one. Making an add-lsp operation will trigger a Pcinitiate message to PCC.
Link to RESTCONF parameters [https://jenkins.opendaylight.org/bgpcep/job/bgpcep-nightly/lastSuccessfulBuild/artifact/target/staging/pcep-parent/pcep-topology-api/network-topology-pcep.html#add-lsp/input/arguments here]

Each RESTCONF operations call requires some xml input that is send via HTTP POST method. Whenever you are sending an xml input, set up HTTP header Content-Type: application/xml.
 
'''RESTCONF URL''' : ''http://localhost:8080/restconf/operations/network-topology-pcep:add-lsp''

'''Method:''' POST

'''Content-Type:''' application/xml

'''Sample input:'''

 <input>
  <node>pcc://43.43.43.43</node>
  <name>update-tunel</name>
 <arguments>
  <lsp xmlns:stateful="urn:opendaylight:params:xml:ns:yang:pcep:ietf:stateful">
   <delegate>false</delegate>
   <administrative>false</administrative>
  </lsp>
  <endpoints-obj>
   <ipv4>
    <source-ipv4-address>43.43.43.43</source-ipv4-address>
    <destination-ipv4-address>39.39.39.39</destination-ipv4-address>
   </ipv4>
  </endpoints-obj>
  <ero>
    <subobject>
     <loose>false</loose>
     <ip-prefix><ip-prefix>201.20.160.43/32</ip-prefix></ip-prefix>
    </subobject>
    <subobject>
     <loose>false</loose>
     <ip-prefix><ip-prefix>195.20.160.40/32</ip-prefix></ip-prefix>
    </subobject>
    <subobject>
     <loose>false</loose>
     <ip-prefix><ip-prefix>39.39.39.39/32</ip-prefix></ip-prefix>
    </subobject>
    </ero> 
 </arguments>
 <network-topology-ref xmlns:topo="urn:TBD:params:xml:ns:yang:network-topology">/topo:network-topology/topo:topology[topo:topology-id="pcep-topology"]</network-topology-ref>
 </input>

'''Details:'''
* <node> : specifies node-id of the PCC, where you want to send the PCEP message. PCEP states that the PCC recieving this message needs to be set as the source of the LSP, otherwise it will ignore the <source-ipv4-address> tag and create a tunnel with the PCC set as source. This node-id can be found when listing all the PCC connected to ODL: ''http:/localhost:8080/restconf/operational/network-topology:network-topology/topology/pcep-topology''
* <name> : name of the LSP
* <arguments> : LSP arguments
* <endpoints-obj> : [http://tools.ietf.org/html/rfc5440#section-7.6 Endpoints object], mandatory, stating the source and destination of the LSP
* <ero> : [http://tools.ietf.org/html/rfc5440#section-7.9 Explicit Route Object], mandatory, specifies hops between source and destination nodes (in this order). This object can be also passed in arguments when creating LSP. Note: '''ODL does NOT order hops, nor does it validate them, therefore user is responsible for putting correct hops in correct order.'''
* <lsp> : [http://tools.ietf.org/html/draft-ietf-pce-stateful-pce-07#section-7.3 LSP Object] mandatory, you have to specify at least delegate and administrative flags

=== Updating LSP ===

Making an update-lsp operation will trigger a Pcupd message to PCC. Updating can be used to change or add additional information to the LSP.

'''RESTCONF URL''' : ''http://localhost:8080/restconf/operations/network-topology-pcep:update-lsp''

'''Method:''' POST

'''Content-Type:''' application/xml

The complete list of arguments can be found [https://jenkins.opendaylight.org/bgpcep/job/bgpcep-nightly/lastSuccessfulBuild/artifact/target/staging/pcep-parent/pcep-topology-api/network-topology-pcep.html#update-lsp/input/arguments here].
For each update, ERO object is mandatory.

=== Removing LSP ===

Removing LSP from PCC is done via following RESTCONF URL. Making a remove-lsp operation will trigger a Pcupd message to PCC, with remove-flag in SRP set to true.

'''RESTCONF URL''' : ''http://localhost:8080/restconf/operations/network-topology-pcep:remove-lsp''

'''Method:''' POST

'''Content-Type:''' application/xml

'''Sample input:'''

 <input>
  <node>pcc://43.43.43.43</node>
  <name>update-tunel</name>
  <network-topology-ref xmlns:topo="urn:TBD:params:xml:ns:yang:network-topology">/topo:network-topology/topo:topology[topo:topology-id="pcep-topology"]</network-topology-ref>
 </input>

'''Details:'''
* <node> : specifies node-id of the PCC, where you want to send the PCEP message. This node-id can be found when listing all the PCC connected to ODL: ''http:/localhost:8080/restconf/operational/network-topology:network-topology/topology/pcep-topology''
* <name> : name of the LSP that you want to remove
